<!-- NetEase Music Player Component -->

<!-- Preconnect to CDNs -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com">

<!-- Defer CSS loading until needed -->
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css"></noscript>

<style>
  /* Floating Music Player */
  #music-floating {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(0, 0, 0, 0.05);
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    will-change: width, height, border-radius, opacity, transform;
    opacity: 0.95;
    z-index: 100;
    touch-action: none;
    overflow: hidden;
  }

  #music-floating:hover {
    opacity: 1;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(0, 0, 0, 0.08);
    transform: scale(1.05);
  }

  #music-floating.dragging {
    transition: none;
    opacity: 1;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  #music-floating .content {
    width: 100%;
    height: 100%;
    border-radius: inherit;
    overflow: hidden;
    position: relative;
  }

  #music-floating.expand-left .content {
    transform-origin: right center;
  }

  #music-floating.expand-right .content {
    transform-origin: left center;
  }

  #music-floating.expanded {
    width: min(540px, 92vw);
    height: 360px;
    border-radius: 20px;
    opacity: 1;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(0, 0, 0, 0.1);
  }

  #music-floating.expanded:hover {
    transform: none;
  }

  /* APlayer Container Styling */
  #music-player {
    display: none;
    width: 100%;
    height: 100%;
    padding: 16px;
    box-sizing: border-box;
    background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
  }

  #music-floating.expanded #music-player {
    display: block;
  }

  #music-floating.expanded #music-icon {
    display: none;
  }

  /* Icon Styling */
  #music-icon {
    text-align: center;
    font-size: 14px;
    color: #333;
    line-height: 60px;
    height: 100%;
    width: 100%;
    position: relative;
  }

  #music-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 50%;
    transition: transform 0.3s ease;
  }

  #music-floating:hover #music-icon img {
    transform: rotate(5deg) scale(1.1);
  }

  /* Now Playing Ticker */
  #music-nowplaying {
    display: none;
    position: absolute;
    bottom: -22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: #666;
    white-space: nowrap;
    max-width: 260px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.95);
    padding: 4px 12px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  #music-nowplaying span {
    display: inline-block;
    padding-left: 100%;
    animation: ticker 15s linear infinite;
  }

  @keyframes ticker {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-100%); }
  }

  /* Loading Animation - Rotate the icon */
  #music-floating.loading #music-icon img {
    animation: spin-icon 5s linear infinite;
  }

  @keyframes spin-icon {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* APlayer Custom Styling */
  .aplayer {
    box-shadow: none !important;
    margin: 0 !important;
    height: 100% !important;
    background: transparent !important;
    border-radius: 12px !important;
  }

  .aplayer .aplayer-body {
    background: transparent !important;
  }

  .aplayer .aplayer-list {
    background: rgba(255, 255, 255, 0.5) !important;
    border-radius: 8px !important;
    margin-top: 8px !important;
  }

  .aplayer .aplayer-list ol li {
    border-top: 1px solid rgba(0, 0, 0, 0.05) !important;
  }

  .aplayer .aplayer-list ol li:hover {
    background: rgba(194, 12, 12, 0.05) !important;
  }

  .aplayer .aplayer-list ol li.aplayer-list-light {
    background: rgba(194, 12, 12, 0.1) !important;
  }

  /* Mobile Responsive */
  @media only screen and (max-width: 768px) {
    #music-floating.expanded {
      width: 92vw;
      height: 340px;
      position: fixed;
    }

    #music-player {
      padding: 12px;
    }

    #music-nowplaying {
      max-width: 200px;
      font-size: 10px;
    }
  }
</style>

<!-- Floating Music Player -->
<div id="music-floating-container"></div>

<script>
  (function() {
    // Prevent multiple initializations (important for SPA)
    if (window.musicPlayerInitialized) {
      console.log('Music player already initialized, skipping...');
      return;
    }
    window.musicPlayerInitialized = true;

    // Create the player HTML dynamically (only once)
    const container = document.getElementById('music-floating-container');
    if (!container) {
      console.error('Music player container not found');
      return;
    }

    container.innerHTML = `
      <div id="music-floating">
        <div class="content">
          <div id="music-icon">
            <img src="{{ '/images/Isla.png' | relative_url }}" alt="Music Player">
          </div>
          <div id="music-player">
            <div id="aplayer"></div>
          </div>
          <div id="music-nowplaying"><span></span></div>
        </div>
      </div>
    `;

    const musicFloating = document.getElementById('music-floating');
    const nowPlaying = document.getElementById('music-nowplaying');

    // Store state globally to persist across SPA navigation
    window.musicPlayerState = window.musicPlayerState || {
      playerInitialized: false,
      scriptsLoaded: false,
      savedPosition: { top: '20px', right: '20px', bottom: '', left: '' },
      currentLimit: 10,  // Start with fewer songs for faster initial load
      maxLimit: 200,
      aplayerInstance: null
    };

    // Shorthand references
    let playerInitialized = window.musicPlayerState.playerInitialized;
    let scriptsLoaded = window.musicPlayerState.scriptsLoaded;
    let savedPosition = window.musicPlayerState.savedPosition;
    let currentLimit = window.musicPlayerState.currentLimit;
    let maxLimit = window.musicPlayerState.maxLimit;
    let aplayerInstance = window.musicPlayerState.aplayerInstance;

    function loadScripts(callback) {
      if (scriptsLoaded) {
        callback();
        return;
      }
      const aplayerScript = document.createElement('script');
      aplayerScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js';
      aplayerScript.async = true;

      const metingScript = document.createElement('script');
      metingScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/meting/2.0.1/Meting.min.js';
      metingScript.async = true;

      aplayerScript.onload = function() {
        document.body.appendChild(metingScript);
      };
      metingScript.onload = function() {
        scriptsLoaded = window.musicPlayerState.scriptsLoaded = true;
        callback();
      };

      document.body.appendChild(aplayerScript);
    }

    function initializePlayer() {
      if (playerInitialized) return;
      musicFloating.classList.add('loading');
      loadScripts(function() {
        const metingElement = document.createElement('meting-js');
        metingElement.setAttribute('server', 'netease');
        metingElement.setAttribute('type', 'playlist');
        metingElement.setAttribute('id', '602810440');
        metingElement.setAttribute('autoplay', 'false');
        metingElement.setAttribute('theme', '#C20C0C');
        metingElement.setAttribute('limit', currentLimit.toString());
        metingElement.setAttribute('volume', '0.1');
        document.getElementById('aplayer').appendChild(metingElement);

        setTimeout(function() {
          const checkAPlayer = setInterval(function() {
            if (window.aplayer && window.aplayer.audio) {
              clearInterval(checkAPlayer);
              aplayerInstance = window.musicPlayerState.aplayerInstance = window.aplayer;
              playerInitialized = window.musicPlayerState.playerInitialized = true;
              musicFloating.classList.remove('loading');
              if (nowPlaying) nowPlaying.style.display = 'block';

              console.log('üéµ Music player ready with', currentLimit, 'songs');
              setupAPlayerEvents();
              setupLazyLoad();
            }
          }, 100);  // Check more frequently (was 200ms)
        }, 500);  // Start checking sooner (was 1000ms)
      });
    }

    function setupLazyLoad() {
      const { scrollContainer, playlistList } = getPlaylistElements();
      if (!scrollContainer || !playlistList) {
        console.log('‚è≥ Waiting for playlist element...');
        setTimeout(setupLazyLoad, 500);
        return;
      }

      console.log('‚úÖ Lazy load enabled - scroll to bottom to load more songs');

      if (lazyLoadScrollContainer && lazyLoadScrollHandler) {
        lazyLoadScrollContainer.removeEventListener('scroll', lazyLoadScrollHandler);
      }

      const containerToUse = scrollContainer;
      lazyLoadScrollContainer = containerToUse;
      lazyLoadScrollHandler = function() {
        const scrollTop = containerToUse.scrollTop;
        const scrollHeight = containerToUse.scrollHeight;
        const clientHeight = containerToUse.clientHeight;
        const scrollBottom = scrollHeight - scrollTop - clientHeight;

        // Debug: log when close to bottom
        if (scrollBottom < 150 && scrollBottom > 50) {
          console.log('üìú Scroll position:', scrollBottom, 'px from bottom');
        }

        if (scrollBottom < 100) {
          loadMoreSongs();
        }
      };

      containerToUse.addEventListener('scroll', lazyLoadScrollHandler);
    }

    let isLoadingMore = false;
    let lazyLoadScrollContainer = null;
    let lazyLoadScrollHandler = null;

    function getPlaylistElements() {
      const playlistWrapper = document.querySelector('.aplayer-list');
      if (!playlistWrapper) {
        return { scrollContainer: null, playlistList: null };
      }
      const scrollContainer = playlistWrapper.querySelector('.aplayer-list-body') ||
        playlistWrapper.querySelector('.aplayer-list-main') ||
        playlistWrapper;
      const playlistList = playlistWrapper.querySelector('ol') ||
        playlistWrapper.querySelector('ul');
      return { scrollContainer, playlistList };
    }

    function loadMoreSongs() {
      if (currentLimit >= maxLimit || isLoadingMore) return;

      const newLimit = Math.min(currentLimit + 10, maxLimit);  // Load 10 at a time instead of 20
      if (newLimit === currentLimit) return;

      isLoadingMore = true;
      console.log('üì• Loading more songs:', currentLimit, '‚Üí', newLimit);

      // Show loading indicator
      const { playlistList } = getPlaylistElements();
      if (playlistList) {
        const loadingItem = document.createElement('li');
        loadingItem.className = 'lazy-loading-indicator';
        loadingItem.innerHTML = '<span style="padding: 10px; color: #999;">Loading more songs...</span>';
        playlistList.appendChild(loadingItem);
      }

      currentLimit = window.musicPlayerState.currentLimit = newLimit;

      const aplayerContainer = document.getElementById('aplayer');
      const metingElement = aplayerContainer.querySelector('meting-js');
      if (metingElement) {
        metingElement.setAttribute('limit', currentLimit.toString());
        const parent = metingElement.parentNode;
        const clone = metingElement.cloneNode(true);
        parent.removeChild(metingElement);
        setTimeout(function() {
          parent.appendChild(clone);
          setTimeout(function() {
            // Remove loading indicator
            const loadingIndicator = document.querySelector('.lazy-loading-indicator');
            if (loadingIndicator) loadingIndicator.remove();

            setupLazyLoad();
            isLoadingMore = false;
            console.log('‚úÖ Loaded', newLimit, 'songs');
          }, 1000);  // Reduced from 1500ms to 1000ms
        }, 50);  // Reduced from 100ms to 50ms
      }
    }

    function setupAPlayerEvents() {
      if (!aplayerInstance) {
        console.error('APlayer instance not found');
        return;
      }

      console.log('Setting up APlayer event listeners');

      aplayerInstance.on('play', function() {
        console.log('APlayer: play event fired');
        updateNowPlaying();
      });

      aplayerInstance.on('pause', function() {
        console.log('APlayer: pause event fired');
      });

      aplayerInstance.on('ended', function() {
        console.log('APlayer: ended event fired');
      });

      aplayerInstance.on('loadeddata', function() {
        console.log('APlayer: loadeddata event fired');
        updateNowPlaying();
      });

      aplayerInstance.on('listswitch', function(index) {
        console.log('APlayer: listswitch event fired, index:', index);
        setTimeout(() => {
          updateNowPlaying();
        }, 400);
      });

      updateNowPlaying();
    }

    function handlePlayerToggle() {
      if (!musicFloating.classList.contains('expanded')) {
        const isMobile = window.innerWidth < 769;
        const targetWidth = isMobile ? Math.min(window.innerWidth - 24, 540) : 540;
        const targetHeight = isMobile ? 340 : 360;
        const padding = 12;
        const rect = musicFloating.getBoundingClientRect();

        const spaceLeft = rect.left;
        const spaceRight = window.innerWidth - rect.right;
        const spaceAbove = rect.top;
        const spaceBelow = window.innerHeight - rect.bottom;

        const expandLeft = spaceLeft > spaceRight;
        musicFloating.classList.remove('expand-left', 'expand-right');
        musicFloating.classList.add(expandLeft ? 'expand-left' : 'expand-right');

        let topPos;
        if (spaceBelow >= targetHeight + padding) {
          topPos = rect.top;
        } else if (spaceAbove >= targetHeight + padding) {
          topPos = rect.bottom - targetHeight;
        } else {
          topPos = Math.max(padding, Math.min(rect.top, window.innerHeight - targetHeight - padding));
        }

        let leftPos;
        if (expandLeft) {
          leftPos = rect.right - targetWidth;
          leftPos = Math.max(padding, leftPos);
        } else {
          leftPos = rect.left;
          leftPos = Math.min(leftPos, window.innerWidth - targetWidth - padding);
        }

        musicFloating.style.top = `${topPos}px`;
        musicFloating.style.left = `${leftPos}px`;
        musicFloating.style.right = 'auto';
        musicFloating.style.bottom = 'auto';

        musicFloating.style.width = `${targetWidth}px`;
        musicFloating.style.height = `${targetHeight}px`;
        musicFloating.classList.add('expanded');
        if (!playerInitialized) initializePlayer();
      } else {
        collapsePlayer();
      }
    }

    function collapsePlayer() {
      musicFloating.classList.remove('expanded');
      musicFloating.style.width = '';
      musicFloating.style.height = '';
      musicFloating.style.top = savedPosition.top;
      musicFloating.style.bottom = savedPosition.bottom;
      musicFloating.style.left = savedPosition.left;
      musicFloating.style.right = savedPosition.right;
    }

    function updateNowPlaying() {
      let title = '';
      let artist = '';

      if (aplayerInstance && aplayerInstance.list && aplayerInstance.list.audios) {
        const currentIndex = aplayerInstance.list.index;
        const currentAudio = aplayerInstance.list.audios[currentIndex];

        if (currentAudio) {
          title = currentAudio.name || currentAudio.title || '';
          artist = currentAudio.artist || '';
          console.log('Got song info from APlayer instance:', { title, artist, index: currentIndex });
        }
      }

      if (!title) {
        const titleEl = document.querySelector('.aplayer-title');
        const artistEl = document.querySelector('.aplayer-author');

        if (titleEl && titleEl.textContent) {
          title = titleEl.textContent.trim();
        }

        if (artistEl && artistEl.textContent) {
          artist = artistEl.textContent.trim();
        }

        if (title || artist) {
          console.log('Got song info from DOM:', { title, artist });
        }
      }

      if (nowPlaying) {
        const text = title ? `${title}${artist ? ' ‚Äî ' + artist : ''}` : '';
        nowPlaying.querySelector('span').textContent = text;
      }
    }

    // Dragging functionality
    let isDragging = false;
    let startX, startY, startRight, startBottom, startTop, startLeft;

    function handleDragStart(e) {
      if (musicFloating.classList.contains('expanded')) {
        if (e.target.closest('#music-icon')) {
          handlePlayerToggle();
        }
        return;
      }
      isDragging = true;
      musicFloating.classList.add('dragging');
      const style = window.getComputedStyle(musicFloating);
      const hasRight = style.right !== 'auto';
      const hasBottom = style.bottom !== 'auto';

      if (hasRight) {
        startRight = parseInt(style.right);
        startLeft = null;
      } else {
        startLeft = parseInt(style.left);
        startRight = null;
      }
      if (hasBottom) {
        startBottom = parseInt(style.bottom);
        startTop = null;
      } else {
        startTop = parseInt(style.top);
        startBottom = null;
      }

      if (e.type === 'mousedown') {
        startX = e.clientX;
        startY = e.clientY;
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
      } else if (e.type === 'touchstart') {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        document.addEventListener('touchmove', handleDragMove, { passive: false });
        document.addEventListener('touchend', handleDragEnd);
      }
      e.preventDefault();
    }

    function handleDragMove(e) {
      if (!isDragging) return;
      let currentX, currentY;
      if (e.type === 'mousemove') {
        currentX = e.clientX;
        currentY = e.clientY;
      } else if (e.type === 'touchmove') {
        currentX = e.touches[0].clientX;
        currentY = e.touches[0].clientY;
        e.preventDefault();
      }
      const diffX = currentX - startX;
      const diffY = currentY - startY;

      if (startRight !== null) {
        musicFloating.style.right = Math.max(0, startRight - diffX) + 'px';
        musicFloating.style.left = 'auto';
      } else if (startLeft !== null) {
        musicFloating.style.left = Math.max(0, startLeft + diffX) + 'px';
        musicFloating.style.right = 'auto';
      }

      if (startBottom !== null) {
        musicFloating.style.bottom = Math.max(0, startBottom - diffY) + 'px';
        musicFloating.style.top = 'auto';
      } else if (startTop !== null) {
        musicFloating.style.top = Math.max(0, startTop + diffY) + 'px';
        musicFloating.style.bottom = 'auto';
      }
    }

    function handleDragEnd(e) {
      if (!isDragging) return;
      let wasDragged = false;
      if (e.type === 'mouseup') {
        const diffX = Math.abs(e.clientX - startX);
        const diffY = Math.abs(e.clientY - startY);
        wasDragged = (diffX > 5 || diffY > 5);
      } else if (e.type === 'touchend' && e.changedTouches && e.changedTouches.length > 0) {
        const diffX = Math.abs(e.changedTouches[0].clientX - startX);
        const diffY = Math.abs(e.changedTouches[0].clientY - startY);
        wasDragged = (diffX > 5 || diffY > 5);
      }

      isDragging = false;
      musicFloating.classList.remove('dragging');
      document.removeEventListener('mousemove', handleDragMove);
      document.removeEventListener('mouseup', handleDragEnd);
      document.removeEventListener('touchmove', handleDragMove);
      document.removeEventListener('touchend', handleDragEnd);

      if (wasDragged) {
        const style = window.getComputedStyle(musicFloating);
        savedPosition = {
          top: style.top !== 'auto' ? style.top : '',
          right: style.right !== 'auto' ? style.right : '',
          bottom: style.bottom !== 'auto' ? style.bottom : '',
          left: style.left !== 'auto' ? style.left : ''
        };
      } else {
        setTimeout(function() {
          handlePlayerToggle();
        }, 10);
      }
    }

    musicFloating.addEventListener('mousedown', handleDragStart);
    musicFloating.addEventListener('touchstart', handleDragStart, { passive: false });

    document.addEventListener('click', function(e) {
      if (!musicFloating.contains(e.target)) {
        collapsePlayer();
      }
    });

    document.getElementById('music-player').addEventListener('click', function(e) {
      e.stopPropagation();
    });

    // Initialize immediately if DOM is already ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('Music player DOM ready');
      });
    } else {
      console.log('Music player initialized (DOM already ready)');
    }
  })();
</script>
