<!-- Paper Preview Modal -->
<div id="previewModal" class="preview-modal">
  <div class="preview-content">
    <span class="preview-close-button">&times;</span>  <!-- Changed class name here -->
    <img id="previewImage" src="" alt="Preview">
  </div>
</div>

<style>
.preview-button {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background-color: rgb(222, 243, 253);
    padding: 2px 8px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
    cursor: pointer;
    border: none;
    transition: background-color 0.2s ease;
  }

.preview-button:hover {
  background-color: rgb(255, 255, 255);
}

.preview-button::before {
  content: "üëÅÔ∏è"; /* Using eye emoji as icon */
  font-size: 1em;
}

.preview-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0);
  transition: background-color 0.3s ease;
  opacity: 0;
}

.preview-modal.show {
  opacity: 1;
  background-color: rgba(0, 0, 0, 0.8);
}

.preview-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  padding: 20px;
  max-width: 90vw;
  max-height: 90vh;
  text-align: center;
  transition: transform 0.3s ease, opacity 0.3s ease;
  opacity: 0;
}

.preview-modal.show .preview-content {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

.preview-content img {
  width: auto;
  max-width: 100%;
  max-height: 70vh;
  object-fit: contain;
  background-color: white;
  border-radius: 4px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.preview-close-button {  /* Changed class name here */
  position: fixed;
  right: 30px;
  top: 20px;
  color: #fff;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
  z-index: 1001;
  opacity: 0;
  transition: opacity 0.3s ease, color 0.2s ease;
  padding: 10px;
  line-height: 1;
}

.preview-modal.show .preview-close-button {  /* Changed class name here */
  opacity: 1;
}

.preview-close-button:hover {  /* Changed class name here */
  color: #fff;
}
</style>

<script>
(function() {
  // Prevent multiple initializations
  if (window.previewModalInitialized) {
    console.log('Preview modal already initialized');
    return;
  }
  window.previewModalInitialized = true;

  var modal = document.getElementById('previewModal');
  var modalContent = modal ? modal.querySelector('.preview-content') : null;
  var modalImg = document.getElementById('previewImage');
  var closeBtn = modal ? modal.querySelector('.preview-close-button') : null;
  if (!modal || !modalContent || !modalImg || !closeBtn) {
    console.warn('Preview modal elements not found');
    return;
  }

  var animationDuration = 300;
  var isTransitioning = false;

  function openModal(imageSrc) {
    if (!imageSrc || isTransitioning) return;
    isTransitioning = true;
    modalImg.src = imageSrc;
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';

    void modal.offsetWidth;
    void modalContent.offsetWidth;

    modal.style.animation = 'fadeIn 0.3s ease-out forwards';
    modalContent.style.animation = 'slideIn 0.3s ease-out forwards';
    modal.classList.add('show');

    setTimeout(function() {
      isTransitioning = false;
    }, animationDuration);
  }

  function closeModal() {
    if (isTransitioning || modal.style.display !== 'block') return;
    isTransitioning = true;

    modal.style.animation = 'fadeOut 0.3s ease-out forwards';
    modalContent.style.animation = 'slideOut 0.3s ease-out forwards';

    setTimeout(function() {
      modal.classList.remove('show');
      modal.style.display = 'none';
      document.body.style.overflow = '';
      modalImg.src = '';
      modal.style.animation = '';
      modalContent.style.animation = '';
      isTransitioning = false;
    }, animationDuration);
  }

  // Use event delegation on document with capture phase to intercept before SPA router
  document.addEventListener('click', function(event) {
    var button = event.target.closest('.preview-button');
    if (!button) return;
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation(); // Stop SPA router from intercepting
    var previewSrc = button.getAttribute('data-preview');
    openModal(previewSrc);
  }, true); // Use capture phase

  closeBtn.addEventListener('click', function(event) {
    event.preventDefault();
    event.stopPropagation();
    closeModal();
  });

  modal.addEventListener('click', function(event) {
    if (event.target === modal) {
      closeModal();
    }
  });

  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeModal();
    }
  });

  console.log('‚úì Preview modal initialized');
})();
</script>
